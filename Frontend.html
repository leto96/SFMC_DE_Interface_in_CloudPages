<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>React App</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/design-system/2.15.3/styles/salesforce-lightning-design-system.min.css"
      integrity="sha512-CZHaPuEiGaHY7oMzQDCLXe77jneFoAu6XehZX5d3LNJWr99HAPSyM5jZ10IfmR8/v9a01m6m94IV8k7TJl1rMg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <style>
      html {
        background: #b0c4df;
      }

      html,
      body {
        padding: 0;
        margin: 0;
        font-family: "Salesforce Sans", -apple-system, BlinkMacSystemFont,
          Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans, Droid Sans,
          Helvetica Neue, sans-serif;
      }

      ul {
        margin-left: 10px;
      }

      #myApp {
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin: 20px;
        height: 600px;
        min-width: 750px;
      }

      #myHeader {
        width: 100%;
        height: 110px;
      }

      #AppBody{
        display: flex;
      }

      #sidebar{
        flex: 1;
        background-color: #fff;
        border: #f3f2f2;
        border-style: solid;
        border-width: 5px;
        border-bottom-left-radius: 5px;
      }

      #apptable{
        flex: 6;
        width: 100%;
      }

      th:hover img.toggleOpenCloseIconImg {
        background-color: red;
      }

      .emptySpace {
        width: 20px;
      }

      .findDEButton {
        margin: 0 10px;
      }

      .linkToGetDataExtension{
        cursor:pointer;
        color:blue;
      }

      span.linkToGetDataExtension:hover {
        text-decoration:underline;
      }

      .toggleOpenCloseIconImg {
        width: 20px;
        height: 20px;
        max-width: 20px;
      }

      .searchDataExtensionContainer {
        display: flex;
        margin-top: auto;
      }

      td {
        max-width: 600px;
      }

      .setDefaultCursor {
        cursor: default;
      }
    </style>
  </head>

  <body>
    <div id="mydiv"></div>

    <!-- REACT Scripts -->
    <script type="text/babel">

      // Main APP
      function App() {
        const [itens, setItens] = React.useState([]);
        const instance = axios.create({
          baseURL: 'https://cloud.comunicacao.serasaexperian.com.br',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        console.log(itens);
          
        React.useEffect(() => {
          // retrieveDEByName('Data Extension');
          // retrieveFoldersByName('Data Extension');
          // retrieveFoldersById(10770);
          // retrieveDEsInsideFolder(10770);
          retrieveChildrenFolders(10770);
        }, []);

        const retriever = (field, value, itemType, operation) => {
          instance.defaults.params = {
            'item': itemType, 
            'type': operation
          }
          return instance.post('/devinscriptcode', JSON.stringify({[field]: value}) ).then(res => {
            const items = res.data.map( item => ({ type: itemType, ...item }) );
            return items;
          }).catch(e => {
            console.log(e);
          });
        }

        const retrieveDEByName = async (name) => {
          const des = await retriever('name', name, 'dataextension', 'retrieveWithName');
          setItens(des);
        };

        const retrieveDEsInsideFolder = async (id) => {
          const des = await retriever('folderID', id, 'dataextension', 'retrieveFromFolder');
          setItens(des);
        };

        const retrieveFoldersByName = async (name) => {
          const folders = await retriever('name', name, 'folder', 'retrieveWithName');
          setItens(folders);
        };

        const retrieveFoldersById = async (id) => {
          const folders = await retriever('id', id, 'folder', 'retrieveByID');
          setItens(folders);
        };

        const retrieveChildrenFolders = async (id) => {
          const folders = await retriever('id', id, 'folder', 'retrieveChildrenFolder');
          setItens(folders);
        };

        const dataExtensions = [];
        const folders = [];

        return (
          <div id="myApp">
            <AppHeader />
            <div id='AppBody'>
              <SideBar />
              <AppTable dataExtensions={dataExtensions} folders={folders} />
            </div>
          </div>
        );
      }

      function SideBar(params) {
        return(
          <div id="sidebar">
            <ul>
              <li>hi</li>
              <li>hi</li>
              <ul>
              <li>hi</li>
              <li>hi</li>
            <ul>
              <li>hi</li>
              <li>hi</li>
              <li>hi</li>
              </ul>
              </ul>
              <li>hi</li>
            </ul>
          </div>
        );
      }

      // Main table
      function AppTable({ dataExtensions = [], folders = [] }) {
        return (
          <table id='apptable' className="slds-table slds-table_cell-buffer slds-table_bordered">
            <thead>
              <tr className="slds-line-height_reset">
                <th className="emptySpace" scope="col">
                  <div className="slds-truncate"></div>
                </th>
                <th className="" scope="col">
                  <div className="slds-truncate" title="Name">
                    Name
                  </div>
                </th>
                <th className="" scope="col">
                  <div className="slds-truncate" title="Customer Key">
                    Customer Key
                  </div>
                </th>
                <th className="" scope="col">
                  <div className="slds-truncate" title="Date Created">
                    Date Created
                  </div>
                </th>
                <th className="" scope="col">
                  <div className="slds-truncate" title="Path">
                    Path
                  </div>
                </th>
              </tr>
            </thead>
            <tbody>
              {folders.map( folder =>
                (<FolderItem key={folder.customerKey} {...folder} />)
              )}
              {dataExtensions.map( dataExtension =>
                (<DataExtensionItem key={dataExtension.customerKey} {...dataExtension} />)
              )}
            </tbody>
          </table>
        );
      }
      
      // Spinner
      function Spinner() {
        return (
          <div className="demo-only demo-only_viewport">
            <div role="status" className="slds-spinner slds-spinner_medium">
              <span className="slds-assistive-text">Loading</span>
              <div className="slds-spinner__dot-a"></div>
              <div className="slds-spinner__dot-b"></div>
            </div>
          </div>
        );
      }

      // List Item
      function ListItem() {}

      // Data Extension Item
      function DataExtensionItem({
        name = 'Dummy DE', customerKey = 'aaaa', path = 'some/path', createdDate = (new Date()).toString(),
        openDEData = () => {alert('Open the DE');}
      }) {

        return (
          <tr className="slds-hint-parent">
            <td data-label="Open Icon" scope="row">
              <img
                title="Data Extension"
                src="./images/database_60.png"
                className="toggleOpenCloseIconImg"
              />
            </td>
            <th data-label="Data Extension Name" scope="row">
              <div className="slds-truncate" title="Data Extension Name">
                <span className='linkToGetDataExtension' onClick={openDEData}>{name}</span>
              </div>
            </th>
            <td data-label="Customer Key">
              <div className="slds-truncate" title="Customer Key">
                {customerKey}
              </div>
            </td>
            <td data-label="Date Created">
              <div className="slds-truncate" title="Created Date">
                {createdDate}
              </div>
            </td>
            <td data-label="Path">
              <div className="slds-truncate" title="Path">
                {path}
              </div>
            </td>
          </tr>
        );
      }

      // Item
      function FolderItem({ name = 'temporary', customerKey = 'AAA-AAAAA-AAAAA-AAAA'
        , openClickHandler = () => { console.log('clicked '); } }) {
        return (
          <tr className="slds-hint-parent">
            <td data-label="Open Icon" scope="row">
              <ToggleFolder openClickHandler={openClickHandler} />
            </td>
            <th data-label="FolderName" scope="row">
              <div className="slds-truncate" title={name}>
                {name}
              </div>
            </th>
            <th data-label="EmptySpace" scope="row">
              <div className="slds-truncate">
              </div>
            </th>
            <th data-label="EmptySpace" scope="row">
              <div className="slds-truncate">
              </div>
            </th>
            <th data-label="EmptySpace" scope="row">
              <div className="slds-truncate">
              </div>
            </th>
          </tr>
        );
      }

      // Button to access folder
      function ToggleFolder({ hasInnerContent = false, openClickHandler }) {
        const { useState } = React;

        const [isHover, setIsHover] = useState(false);
        const [isOpen, setIsOpen] = useState(false);

        const setHoveredColorHandler = () => {
          if(hasInnerContent && !isOpen){
            setIsHover(true);
          }
        };

        const setNormalColorHandler = () => {
          setIsHover(false);
        };

        const openHandler = () => {
          setIsOpen(true);
          setIsHover(false);
          openClickHandler();
          // To do: display/show inner contetn
        };

        const closeHandler = () => {
          setIsOpen(false);
          // To do: display folders
        };

        const clickHandler = (e) => {
          e.preventDefault();
          if( !isOpen && hasInnerContent ){
            openHandler();
          }else{
            closeHandler();
          }
        }

        const setStyleClasses = () => {
          let classes = 'slds-checkbox-button';
          if(isHover){
            classes += ' slds-checkbox-button_is-checked';
          }

          if(!hasInnerContent){
            classes += ' setDefaultCursor';
          }

          return classes;
        };

        return (
          <label
            className={setStyleClasses()}
            onMouseEnter={setHoveredColorHandler}
            onMouseLeave={setNormalColorHandler}
            onClick={clickHandler}
          >
              <img
                src={isOpen ? "./images/arrowdown_60.png" : "./images/arrow_right_60.png"}
                className="toggleOpenCloseIconImg"
              />
          </label>
        );
      }

      // App Header
      function AppHeader() {
        return (
          <div id="myHeader" className="slds-page-header">
            <div className="slds-page-header__row">
              <div className="slds-page-header__col-title">
                <div className="slds-media">
                  <div className="slds-media__figure">
                    <img src="./images/box_notes.svg" />
                    <span className="slds-assistive-text">DEs</span>
                  </div>
                  <div className="slds-media__body">
                    <div className="slds-page-header__name">
                      <div className="slds-page-header__name-title">
                        <h1>
                          <span
                            className="slds-page-header__title"
                            title="Data Extension Information"
                          >
                            Data Extension Information
                          </span>
                        </h1>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <DataExtensionSearch />
            </div>
          </div>
        );
      }

      // Data Extension Search
      function DataExtensionSearch(params) {
        return (
          <div className="slds-form searchDataExtensionContainer">
            <div className="slds-form__row">
              <div className="slds-form__item">
                <label
                  className="slds-form-element__label"
                  htmlFor="form-element-03"
                >
                  Data Extension Name
                </label>
                <div
                  className={
                    "slds-form-element__control" +
                    /* hasError */ (false ? " slds-has-error" : "")
                  }
                >
                  <input
                    type="text"
                    aria-invalid="true"
                    aria-describedby="form-error-01"
                    // value={deName}
                    className="slds-input"
                    // onChange={(e) => onChangeHandler(e.target.value)}
                  />
                  {
                    /* hasError */ false ? (
                      <div
                        className="slds-form-element__help"
                        id="form-error-01"
                      >
                        Must have at least 4 chars
                      </div>
                    ) : null
                  }
                </div>
                <button
                  className="slds-button slds-button_brand findDEButton"
                  // onClick={onClickHandler}
                >
                  Find
                </button>
              </div>
            </div>
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("mydiv"));
    </script>
  </body>
</html>
